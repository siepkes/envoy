diff --git a/trees.c b/trees.c
index 50cf4b4..e705576 100644
--- a/trees.c
+++ b/trees.c
@@ -870,7 +870,9 @@ void ZLIB_INTERNAL _tr_stored_block(s, buf, stored_len, last)
     bi_windup(s);        /* align on byte boundary */
     put_short(s, (ush)stored_len);
     put_short(s, (ush)~stored_len);
-    zmemcpy(s->pending_buf + s->pending, (Bytef *)buf, stored_len);
+    if (stored_len > 0) {
+        zmemcpy(s->pending_buf + s->pending, (Bytef *)buf, stored_len);
+    }
     s->pending += stored_len;
 #ifdef ZLIB_DEBUG
     s->compressed_len = (s->compressed_len + 3 + 7) & (ulg)~7L;
-- 
2.21.0.593.g511ec345e18-goog

From 28aa7820d3875973a45027c06682df756e5566b7 Mon Sep 17 00:00:00 2001
From: Jasper Siepkes <siepkes@serviceplanet.nl>
Date: Tue, 11 Dec 2018 11:06:38 +0100
Subject: [PATCH] Don't specify --version-script on Solaris / Illumos in
 CMakeLists.txt.

The Solaris / Illumos linker does not support --version-script.
---
 CMakeLists.txt | 2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 0fe939df..eff4692c 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -202,7 +202,7 @@ endif()
 if(UNIX)
     # On unix-like platforms the library is almost always called libz
    set_target_properties(zlib zlibstatic PROPERTIES OUTPUT_NAME z)
-   if(NOT APPLE)
+   if(NOT APPLE AND NOT "${CMAKE_SYSTEM_NAME}" MATCHES "SunOS")
      set_target_properties(zlib PROPERTIES LINK_FLAGS "-Wl,--version-script,\"${CMAKE_CURRENT_SOURCE_DIR}/zlib.map\"")
    endif()
 elseif(BUILD_SHARED_LIBS AND WIN32)
